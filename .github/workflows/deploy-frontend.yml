name: Deploy Frontend to Amazon Linux 2023

on:
  push:
    branches: [main]
    paths:
      - "src/**"
      - "public/**"
      - "package.json"
      - "vite.config.js"
      - ".github/workflows/deploy-frontend.yml"
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

env:
  AWS_REGION: ap-northeast-2
  NODE_VERSION: 18
  BUILD_PATH: dist

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“ Create Production Environment File
        run: |
          cat > .env.production << EOF
          VITE_API_BASE_URL=/api
          VITE_TIMEOUT=30000
          VITE_DEBUG_MODE=false
          VITE_LOG_LEVEL=error
          VITE_ENABLE_CACHE=true
          EOF

      - name: ğŸ“¦ Install dependencies
        run: |
          echo "ğŸ“¦ Installing npm dependencies..."
          npm ci --production=false

      - name: ğŸ—ï¸ Build for production
        run: |
          echo "ğŸ—ï¸ Building Vue.js application..."
          npm run build

          # ë¹Œë“œ ê²€ì¦
          if [ ! -f "${{ env.BUILD_PATH }}/index.html" ]; then
            echo "âŒ Build failed: index.html not found"
            exit 1
          fi

          echo "ğŸ“Š Build completed successfully:"
          ls -la ${{ env.BUILD_PATH }}/
          du -sh ${{ env.BUILD_PATH }}/

      - name: ğŸ“¦ Create deployment package
        run: |
          cd ${{ env.BUILD_PATH }}
          tar -czf ../frontend-build.tar.gz .
          cd ..
          echo "âœ… Package created: $(ls -lh frontend-build.tar.gz)"

      - name: ğŸ” Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ” Check Instance Status
        run: |
          echo "ğŸ” Checking instance status before deployment..."

          # Blue Instance ìƒíƒœ í™•ì¸
          BLUE_STATE=$(aws ec2 describe-instances \
            --instance-ids ${{ secrets.VPC1_BLUE_INSTANCE_ID }} \
            --query 'Reservations[0].Instances[0].State.Name' \
            --output text)
          echo "Blue Instance State: $BLUE_STATE"

          # Green Instance ìƒíƒœ í™•ì¸
          GREEN_STATE=$(aws ec2 describe-instances \
            --instance-ids ${{ secrets.VPC1_GREEN_INSTANCE_ID }} \
            --query 'Reservations[0].Instances[0].State.Name' \
            --output text)
          echo "Green Instance State: $GREEN_STATE"

          # SSM Agent ìƒíƒœ í™•ì¸
          echo "ğŸ” Checking SSM Agent status..."
          aws ssm describe-instance-information \
            --filters "Key=InstanceIds,Values=${{ secrets.VPC1_BLUE_INSTANCE_ID }},${{ secrets.VPC1_GREEN_INSTANCE_ID }}" \
            --query 'InstanceInformationList[*].[InstanceId,PingStatus,LastPingDateTime]' \
            --output table || echo "âš ï¸ SSM status check failed"

      - name: ğŸš€ Deploy to Blue Instance (Amazon Linux 2023)
        run: |
          echo "ğŸš€ Deploying to Blue Instance (Amazon Linux 2023)..."

          # Amazon Linux 2023 ìµœì í™”ëœ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸
          aws ssm send-command \
            --instance-ids ${{ secrets.VPC1_BLUE_INSTANCE_ID }} \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "#!/bin/bash",
              "set -euo pipefail",
              "echo \"=== ğŸ”„ Starting Vue.js deployment (BLUE - Amazon Linux 2023) ===\"",
              "echo \"Build time: $(date)\"",
              "echo \"Current user: $(whoami)\"",
              "echo \"OS Info: $(cat /etc/os-release | grep PRETTY_NAME)\"",
              "",
              "# ì‹œìŠ¤í…œ ì •ë³´ í™•ì¸",
              "echo \"=== ğŸ“‹ System Information ===\"",
              "echo \"Kernel: $(uname -r)\"",
              "echo \"Architecture: $(uname -m)\"",
              "free -h",
              "df -h",
              "",
              "echo \"=== ğŸ“ Preparing deployment directory ===\"",
              "sudo mkdir -p /tmp/vue-build",
              "sudo rm -rf /tmp/vue-build/*",
              "",
              "echo \"=== ğŸ“¥ Downloading source from GitHub ===\"",
              "cd /tmp",
              "curl -L -f --retry 3 --retry-delay 5 -o frontend-build.tar.gz \"https://github.com/Pive-Guyz/be14-fin-Empick-FE/archive/main.tar.gz\" || { echo \"âŒ Failed to download from GitHub\"; exit 1; }",
              "ls -la frontend-build.tar.gz",
              "",
              "echo \"=== ğŸ“¦ Extracting source ===\"",
              "tar -xzf frontend-build.tar.gz || { echo \"âŒ Failed to extract archive\"; exit 1; }",
              "ls -la",
              "cd be14-fin-Empick-FE-main || { echo \"âŒ Source directory not found\"; exit 1; }",
              "pwd && ls -la",
              "",
              "echo \"=== ğŸ”§ Node.js setup (Amazon Linux 2023) ===\"",
              "if ! command -v node &> /dev/null; then",
              "  echo \"Installing Node.js 18 for Amazon Linux 2023...\"",
              "  # Amazon Linux 2023ìš© Node.js ì„¤ì¹˜",
              "  curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -",
              "  sudo dnf install -y --allowerasing nodejs || { echo \"âŒ Failed to install Node.js\"; exit 1; }",
              "else",
              "  echo \"Node.js already installed\"",
              "fi",
              "node --version && npm --version",
              "",
              "echo \"=== ğŸ“¦ Installing dependencies ===\"",
              "# npm cache ì •ë¦¬",
              "npm cache clean --force",
              "npm ci --production=false || { echo \"âŒ Failed to install dependencies\"; exit 1; }",
              "",
              "echo \"=== ğŸ—ï¸ Building Vue.js application ===\"",
              "npm run build || { echo \"âŒ Failed to build Vue.js app\"; exit 1; }",
              "",
              "echo \"Build verification:\"",
              "ls -la dist/ && du -sh dist/",
              "test -f dist/index.html || { echo \"âŒ index.html not found in build\"; exit 1; }",
              "",
              "echo \"=== ğŸ“‚ Preparing for deployment ===\"",
              "sudo rm -rf /tmp/vue-build/*",
              "sudo cp -r dist/* /tmp/vue-build/ || { echo \"âŒ Failed to copy build files\"; exit 1; }",
              "echo \"Deployment directory contents:\"",
              "ls -la /tmp/vue-build/",
              "",
              "echo \"=== ğŸš€ Running deployment script ===\"",
              "test -f /home/ec2-user/deploy.sh || { echo \"âŒ deploy.sh not found\"; exit 1; }",
              "sudo /home/ec2-user/deploy.sh || { echo \"âŒ Deployment script failed\"; exit 1; }",
              "",
              "echo \"=== âœ… Blue deployment completed! ===\"",
              "ls -la /var/www/html/ | head -5",
              "curl -s localhost/health || echo \"âš ï¸ Health check failed\"",
              "curl -s localhost | head -3 || echo \"âš ï¸ Local curl test failed\"",
              "",
              "echo \"=== ğŸ§¹ Cleanup ===\"",
              "cd / && sudo rm -rf /tmp/be14-fin-Empick-FE-main /tmp/frontend-build.tar.gz",
              "",
              "echo \"=== ğŸ‰ Deployment Summary ===\"",
              "echo \"Nginx Status: $(sudo systemctl is-active nginx)\"",
              "echo \"SSM Agent Status: $(sudo systemctl is-active amazon-ssm-agent)\"",
              "echo \"Deployment completed at: $(date)\""
            ]' \
            --timeout-seconds 1800 \
            --output text \
            --comment "Blue Instance Deployment (Amazon Linux 2023)"

      - name: â° Wait for Blue deployment
        run: |
          echo "â° Waiting for Blue deployment to complete..."
          sleep 180

      - name: ğŸš€ Deploy to Green Instance (Amazon Linux 2023)
        run: |
          echo "ğŸš€ Deploying to Green Instance (Amazon Linux 2023)..."

          aws ssm send-command \
            --instance-ids ${{ secrets.VPC1_GREEN_INSTANCE_ID }} \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "#!/bin/bash",
              "set -euo pipefail",
              "echo \"=== ğŸ”„ Starting Vue.js deployment (GREEN - Amazon Linux 2023) ===\"",
              "echo \"Build time: $(date)\"",
              "echo \"Current user: $(whoami)\"",
              "echo \"OS Info: $(cat /etc/os-release | grep PRETTY_NAME)\"",
              "",
              "# ì‹œìŠ¤í…œ ì •ë³´ í™•ì¸",
              "echo \"=== ğŸ“‹ System Information ===\"",
              "echo \"Kernel: $(uname -r)\"",
              "echo \"Architecture: $(uname -m)\"",
              "free -h",
              "df -h",
              "",
              "echo \"=== ğŸ“ Preparing deployment directory ===\"",
              "sudo mkdir -p /tmp/vue-build",
              "sudo rm -rf /tmp/vue-build/*",
              "",
              "echo \"=== ğŸ“¥ Downloading source from GitHub ===\"",
              "cd /tmp",
              "curl -L -f --retry 3 --retry-delay 5 -o frontend-build.tar.gz \"https://github.com/Pive-Guyz/be14-fin-Empick-FE/archive/main.tar.gz\" || { echo \"âŒ Failed to download from GitHub\"; exit 1; }",
              "ls -la frontend-build.tar.gz",
              "",
              "echo \"=== ğŸ“¦ Extracting source ===\"",
              "tar -xzf frontend-build.tar.gz || { echo \"âŒ Failed to extract archive\"; exit 1; }",
              "ls -la",
              "cd be14-fin-Empick-FE-main || { echo \"âŒ Source directory not found\"; exit 1; }",
              "pwd && ls -la",
              "",
              "echo \"=== ğŸ”§ Node.js setup (Amazon Linux 2023) ===\"",
              "if ! command -v node &> /dev/null; then",
              "  echo \"Installing Node.js 18 for Amazon Linux 2023...\"",
              "  # Amazon Linux 2023ìš© Node.js ì„¤ì¹˜",
              "  curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -",
              "  sudo dnf install -y --allowerasing nodejs || { echo \"âŒ Failed to install Node.js\"; exit 1; }",
              "else",
              "  echo \"Node.js already installed\"",
              "fi",
              "node --version && npm --version",
              "",
              "echo \"=== ğŸ“¦ Installing dependencies ===\"",
              "# npm cache ì •ë¦¬",
              "npm cache clean --force",
              "npm ci --production=false || { echo \"âŒ Failed to install dependencies\"; exit 1; }",
              "",
              "echo \"=== ğŸ—ï¸ Building Vue.js application ===\"",
              "npm run build || { echo \"âŒ Failed to build Vue.js app\"; exit 1; }",
              "",
              "echo \"Build verification:\"",
              "ls -la dist/ && du -sh dist/",
              "test -f dist/index.html || { echo \"âŒ index.html not found in build\"; exit 1; }",
              "",
              "echo \"=== ğŸ“‚ Preparing for deployment ===\"",
              "sudo rm -rf /tmp/vue-build/*",
              "sudo cp -r dist/* /tmp/vue-build/ || { echo \"âŒ Failed to copy build files\"; exit 1; }",
              "echo \"Deployment directory contents:\"",
              "ls -la /tmp/vue-build/",
              "",
              "echo \"=== ğŸš€ Running deployment script ===\"",
              "test -f /home/ec2-user/deploy.sh || { echo \"âŒ deploy.sh not found\"; exit 1; }",
              "sudo /home/ec2-user/deploy.sh || { echo \"âŒ Deployment script failed\"; exit 1; }",
              "",
              "echo \"=== âœ… Green deployment completed! ===\"",
              "ls -la /var/www/html/ | head -5",
              "curl -s localhost/health || echo \"âš ï¸ Health check failed\"",
              "curl -s localhost | head -3 || echo \"âš ï¸ Local curl test failed\"",
              "",
              "echo \"=== ğŸ§¹ Cleanup ===\"",
              "cd / && sudo rm -rf /tmp/be14-fin-Empick-FE-main /tmp/frontend-build.tar.gz",
              "",
              "echo \"=== ğŸ‰ Deployment Summary ===\"",
              "echo \"Nginx Status: $(sudo systemctl is-active nginx)\"",
              "echo \"SSM Agent Status: $(sudo systemctl is-active amazon-ssm-agent)\"",
              "echo \"Deployment completed at: $(date)\""
            ]' \
            --timeout-seconds 1800 \
            --output text \
            --comment "Green Instance Deployment (Amazon Linux 2023)"

      - name: â° Wait for Green deployment
        run: |
          echo "â° Waiting for Green deployment to complete..."
          sleep 180

      - name: ğŸ§ª Final Health Check
        run: |
          echo "ğŸ§ª Performing final health check..."
          ALB_URL="${{ secrets.VPC1_ALB_URL }}"

          for i in {1..10}; do
            echo "ğŸ” Attempt $i/10..."
            
            # Health endpoint ì²´í¬
            if curl -f -s "$ALB_URL/health" | grep -q "healthy"; then
              echo "âœ… Health check endpoint OK!"
            else
              echo "âš ï¸ Health check endpoint failed"
            fi
            
            # ë©”ì¸ í˜ì´ì§€ ì²´í¬
            if curl -f -s "$ALB_URL/" | grep -q -E "(Vite|Vue|app|Empick)"; then
              echo "âœ… Main page check passed!"
              echo "ğŸŒ Website: $ALB_URL"
              break
            fi
            
            if [ $i -eq 10 ]; then
              echo "âŒ Final health check failed"
              echo "Response from ALB:"
              curl -s "$ALB_URL/" | head -10
              exit 1
            fi
            sleep 20
          done

      - name: ğŸ“Š Deployment Summary
        run: |
          echo "ğŸ‰ Amazon Linux 2023 ê¸°ë°˜ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ğŸŒ Frontend URL: ${{ secrets.VPC1_ALB_URL }}"
          echo "ğŸ”§ OS: Amazon Linux 2023"
          echo "ğŸ“¦ Package Manager: dnf"
          echo "ğŸš€ Web Server: Nginx"
          echo "â±ï¸ Total deployment time: Optimized for AL2023!"

      - name: âŒ Deployment Failed
        if: failure()
        run: |
          echo "âŒ Amazon Linux 2023 ê¸°ë°˜ Vue.js ë°°í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤!"
          echo ""
          echo "ğŸ”§ ë¬¸ì œ í•´ê²° ë‹¨ê³„:"
          echo "1. AWS SSM Run Command ìƒíƒœë¥¼ AWS Consoleì—ì„œ í™•ì¸"
          echo "2. ì¸ìŠ¤í„´ìŠ¤ ìƒíƒœ í™•ì¸:"
          echo "   aws ec2 describe-instances --instance-ids ${{ secrets.VPC1_BLUE_INSTANCE_ID }} ${{ secrets.VPC1_GREEN_INSTANCE_ID }}"
          echo "3. SSM Agent ìƒíƒœ í™•ì¸:"
          echo "   aws ssm describe-instance-information --filters \"Key=InstanceIds,Values=${{ secrets.VPC1_BLUE_INSTANCE_ID }},${{ secrets.VPC1_GREEN_INSTANCE_ID }}\""
          echo "4. SSMìœ¼ë¡œ ì¸ìŠ¤í„´ìŠ¤ ì ‘ì†í•˜ì—¬ ë¡œê·¸ í™•ì¸:"
          echo "   aws ssm start-session --target ${{ secrets.VPC1_BLUE_INSTANCE_ID }}"
          echo "5. ë¡œê·¸ íŒŒì¼ í™•ì¸:"
          echo "   - Nginx error log: sudo tail -f /var/log/nginx/error.log"
          echo "   - Nginx access log: sudo tail -f /var/log/nginx/access.log"
          echo "   - System log: sudo journalctl -u nginx -f"
          echo "   - User Data log: sudo tail -f /var/log/user-data.log"
          echo "6. Amazon Linux 2023 íŒ¨í‚¤ì§€ í™•ì¸:"
          echo "   - Node.js: node --version && npm --version"
          echo "   - DNF: dnf --version"
          echo "   - OS: cat /etc/os-release"
          echo "7. ìˆ˜ë™ ë¹Œë“œ í…ŒìŠ¤íŠ¸:"
          echo "   - cd /tmp && curl -L https://github.com/Pive-Guyz/be14-fin-Empick-FE/archive/main.tar.gz | tar -xz"
          echo "   - cd be14-fin-Empick-FE-main && npm ci && npm run build"
          echo "8. ë””ìŠ¤í¬ ê³µê°„ í™•ì¸: df -h"
          echo "9. ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ í™•ì¸: cat /home/ec2-user/deploy.sh"
          echo "10. Nginx ì„¤ì • í…ŒìŠ¤íŠ¸: sudo nginx -t"
          echo "11. ì›¹ ë””ë ‰í† ë¦¬ í™•ì¸: ls -la /var/www/html/"
