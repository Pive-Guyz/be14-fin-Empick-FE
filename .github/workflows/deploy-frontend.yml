name: Deploy Frontend Compatible (No S3)

on:
  push:
    branches: [main]
    paths:
      - "src/**"
      - "public/**"
      - "package.json"
      - "vite.config.js"
      - ".github/workflows/deploy-frontend.yml"
  workflow_dispatch: # 수동 실행 가능

env:
  AWS_REGION: ap-northeast-2
  NODE_VERSION: 18
  BUILD_PATH: dist

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🔧 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: 📝 Create Production Environment File
        run: |
          cat > .env.production << EOF
          VITE_API_BASE_URL=/api
          VITE_TIMEOUT=30000
          VITE_DEBUG_MODE=false
          VITE_LOG_LEVEL=error
          VITE_ENABLE_CACHE=true
          EOF

      - name: 📦 Install dependencies
        run: |
          echo "📦 Installing npm dependencies..."
          npm ci --production=false

      - name: 🏗️ Build for production
        run: |
          echo "🏗️ Building Vue.js application..."
          npm run build

          # 빌드 검증
          if [ ! -f "${{ env.BUILD_PATH }}/index.html" ]; then
            echo "❌ Build failed: index.html not found"
            exit 1
          fi

          echo "📊 Build completed successfully:"
          ls -la ${{ env.BUILD_PATH }}/
          du -sh ${{ env.BUILD_PATH }}/

      - name: 📦 Create deployment package
        run: |
          cd ${{ env.BUILD_PATH }}
          tar -czf ../frontend-build.tar.gz .
          cd ..
          echo "✅ Package created: $(ls -lh frontend-build.tar.gz)"

      - name: 🔐 Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: 🚀 Deploy to Blue Instance
        run: |
          echo "🚀 Deploying to Blue Instance..."

          # User Data deploy.sh와 호환되는 방식 - 에러 처리 강화
          aws ssm send-command \
            --instance-ids ${{ secrets.VPC1_BLUE_INSTANCE_ID }} \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "set -euo pipefail",
              "echo \"=== 🔄 Starting Vue.js deployment (BLUE) ===\"",
              "echo \"Build time: $(date)\"",
              "echo \"Current user: $(whoami)\"",
              "echo \"=== 📁 Preparing deployment directory ===\"",
              "sudo mkdir -p /tmp/vue-build",
              "sudo rm -rf /tmp/vue-build/*",
              "echo \"=== 📥 Downloading source from GitHub ===\"",
              "cd /tmp",
              "curl -L -f --retry 3 --retry-delay 5 -o frontend-build.tar.gz \"https://github.com/Pive-Guyz/be14-fin-Empick-FE/archive/main.tar.gz\" || { echo \"❌ Failed to download from GitHub\"; exit 1; }",
              "ls -la frontend-build.tar.gz",
              "echo \"=== 📦 Extracting source ===\"",
              "tar -xzf frontend-build.tar.gz || { echo \"❌ Failed to extract archive\"; exit 1; }",
              "ls -la",
              "cd be14-fin-Empick-FE-main || { echo \"❌ Source directory not found\"; exit 1; }",
              "pwd && ls -la",
              "echo \"=== 🔧 Node.js setup ===\"",
              "if ! command -v node &> /dev/null; then",
              "  echo \"Installing Node.js 18...\"",
              "  curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -",
              "  sudo dnf install -y --allowerasing nodejs || { echo \"❌ Failed to install Node.js\"; exit 1; }",
              "fi",
              "node --version && npm --version",
              "echo \"=== 📦 Installing dependencies ===\"",
              "npm ci --production=false || { echo \"❌ Failed to install dependencies\"; exit 1; }",
              "echo \"=== 🏗️ Building Vue.js application ===\"",
              "npm run build || { echo \"❌ Failed to build Vue.js app\"; exit 1; }",
              "echo \"Build verification:\"",
              "ls -la dist/ && du -sh dist/",
              "test -f dist/index.html || { echo \"❌ index.html not found in build\"; exit 1; }",
              "echo \"=== 📂 Preparing for deployment ===\"",
              "sudo rm -rf /tmp/vue-build/*",
              "sudo cp -r dist/* /tmp/vue-build/ || { echo \"❌ Failed to copy build files\"; exit 1; }",
              "echo \"Deployment directory contents:\"",
              "ls -la /tmp/vue-build/",
              "echo \"=== 🚀 Running deployment script ===\"",
              "test -f /home/ec2-user/deploy.sh || { echo \"❌ deploy.sh not found\"; exit 1; }",
              "sudo /home/ec2-user/deploy.sh || { echo \"❌ Deployment script failed\"; exit 1; }",
              "echo \"=== ✅ Blue deployment completed! ===\"",
              "ls -la /var/www/html/ | head -5",
              "curl -s localhost | head -3 || echo \"⚠️ Local curl test failed\"",
              "echo \"=== 🧹 Cleanup ===\"",
              "cd / && sudo rm -rf /tmp/be14-fin-Empick-FE-main /tmp/frontend-build.tar.gz"
            ]' \
            --output text

      - name: ⏰ Wait for Blue deployment
        run: sleep 120

      - name: 🚀 Deploy to Green Instance
        run: |
          echo "🚀 Deploying to Green Instance..."

          aws ssm send-command \
            --instance-ids ${{ secrets.VPC1_GREEN_INSTANCE_ID }} \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "set -euo pipefail",
              "echo \"=== 🔄 Starting Vue.js deployment (GREEN) ===\"",
              "echo \"Build time: $(date)\"",
              "echo \"Current user: $(whoami)\"",
              "echo \"=== 📁 Preparing deployment directory ===\"",
              "sudo mkdir -p /tmp/vue-build",
              "sudo rm -rf /tmp/vue-build/*",
              "echo \"=== 📥 Downloading source from GitHub ===\"",
              "cd /tmp",
              "curl -L -f --retry 3 --retry-delay 5 -o frontend-build.tar.gz \"https://github.com/Pive-Guyz/be14-fin-Empick-FE/archive/main.tar.gz\" || { echo \"❌ Failed to download from GitHub\"; exit 1; }",
              "ls -la frontend-build.tar.gz",
              "echo \"=== 📦 Extracting source ===\"",
              "tar -xzf frontend-build.tar.gz || { echo \"❌ Failed to extract archive\"; exit 1; }",
              "ls -la",
              "cd be14-fin-Empick-FE-main || { echo \"❌ Source directory not found\"; exit 1; }",
              "pwd && ls -la",
              "echo \"=== 🔧 Node.js setup ===\"",
              "if ! command -v node &> /dev/null; then",
              "  echo \"Installing Node.js 18...\"",
              "  curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -",
              "  sudo dnf install -y --allowerasing nodejs || { echo \"❌ Failed to install Node.js\"; exit 1; }",
              "fi",
              "node --version && npm --version",
              "echo \"=== 📦 Installing dependencies ===\"",
              "npm ci --production=false || { echo \"❌ Failed to install dependencies\"; exit 1; }",
              "echo \"=== 🏗️ Building Vue.js application ===\"",
              "npm run build || { echo \"❌ Failed to build Vue.js app\"; exit 1; }",
              "echo \"Build verification:\"",
              "ls -la dist/ && du -sh dist/",
              "test -f dist/index.html || { echo \"❌ index.html not found in build\"; exit 1; }",
              "echo \"=== 📂 Preparing for deployment ===\"",
              "sudo rm -rf /tmp/vue-build/*",
              "sudo cp -r dist/* /tmp/vue-build/ || { echo \"❌ Failed to copy build files\"; exit 1; }",
              "echo \"Deployment directory contents:\"",
              "ls -la /tmp/vue-build/",
              "echo \"=== 🚀 Running deployment script ===\"",
              "test -f /home/ec2-user/deploy.sh || { echo \"❌ deploy.sh not found\"; exit 1; }",
              "sudo /home/ec2-user/deploy.sh || { echo \"❌ Deployment script failed\"; exit 1; }",
              "echo \"=== ✅ Green deployment completed! ===\"",
              "ls -la /var/www/html/ | head -5",
              "curl -s localhost | head -3 || echo \"⚠️ Local curl test failed\"",
              "echo \"=== 🧹 Cleanup ===\"",
              "cd / && sudo rm -rf /tmp/be14-fin-Empick-FE-main /tmp/frontend-build.tar.gz"
            ]' \
            --output text

      - name: ⏰ Wait for Green deployment
        run: sleep 120

      - name: 🧪 Final Health Check
        run: |
          echo "🧪 Performing final health check..."
          ALB_URL="${{ secrets.VPC1_ALB_URL }}"

          for i in {1..10}; do
            echo "🔍 Attempt $i/10..."
            if curl -f -s "$ALB_URL/" | grep -q "Vite\|Vue\|app"; then
              echo "✅ Health check passed!"
              echo "🌐 Website: $ALB_URL"
              break
            fi
            if [ $i -eq 10 ]; then
              echo "❌ Health check failed"
              curl -s "$ALB_URL/" | head -5
              exit 1
            fi
            sleep 15
          done

      - name: 📊 Deployment Summary
        run: |
          echo "🎉 Deployment completed successfully!"
          echo "🌐 Frontend URL: ${{ secrets.VPC1_ALB_URL }}"
          echo "⏱️ Total time: Compatible with existing infrastructure!"

      - name: ❌ Deployment Failed
        if: failure()
        run: |
          echo "❌ Vue.js deployment failed!"
          echo "🔧 Troubleshooting steps:"
          echo "1. Check AWS SSM Run Command status in AWS Console"
          echo "2. SSH to instances and check logs:"
          echo "   - Nginx error log: sudo tail -f /var/log/nginx/error.log"
          echo "   - Nginx access log: sudo tail -f /var/log/nginx/access.log"
          echo "   - System log: sudo journalctl -u nginx -f"
          echo "3. Check Node.js installation: node --version && npm --version"
          echo "4. Check build process manually:"
          echo "   - cd /tmp && git clone https://github.com/Pive-Guyz/be14-fin-Empick-FE.git"
          echo "   - cd be14-fin-Empick-FE && npm ci && npm run build"
          echo "5. Check disk space: df -h"
          echo "6. Check deployment script: cat /home/ec2-user/deploy.sh"
          echo "7. Test Nginx configuration: sudo nginx -t"
          echo "8. Check web directory: ls -la /var/www/html/"
